<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:500,700,900">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
  </head>
  <body class="index">
    <main>
      <div id="main-0" class="bg-secondary">
        <section class="p-aside" style="background-image: url(splash.jpg);">
          <div class="position-relative h-100 p-5">
            <h1>Hello, world!</h1>
          </div>
        </section>
        <section class="p-aside">
          <div class="position-relative h-100 p-5">
            <h1>Hello, world!</h1>
          </div>
        </section>
        <section class="p-aside">
          <div class="position-relative h-100 p-5">
            <h1>Hello, world!</h1>
          </div>
        </section>
      </div>
      <div id="main-1" class="bg-transition bg-primary text-center d-none">
        <section class="p-aside">
          <div class="position-relative h-100 p-5">
            <div id="topic-dropdown" class="dropdown">
              <button class="btn btn-outline-light dropdown-toggle" type="button" data-toggle="dropdown">주제 선택하기</button>
              <div class="dropdown-menu">
                <button id="topic-0" class="dropdown-item" type="button"></button>
                <button id="topic-1" class="dropdown-item" type="button"></button>
                <button id="topic-2" class="dropdown-item" type="button"></button>
                <button id="topic-3" class="dropdown-item" type="button"></button>
              </div>
            </div>
            <div id="grad-actions" class="d-none">
              <button id="grad-shuffle" type="button" class="btn btn-outline-light">Refresh</button><button id="grad-select" type="button" class="btn btn-outline-light" disabled>Confirm</button>
            </div>
            <svg id="ellipse-myself" xmlns="http://www.w3.org/2000/svg" width="360" height="120" class="d-none">
              <defs>
                <linearGradient id="grad-0" x1="0" x2="1" >
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-1" x1="0" x2="1" >
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-2" x1="0" x2="1" >
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-3" x1="0" x2="1" >
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
              </defs>
              <ellipse cx="180" cy="60" rx="179" ry="59" stroke="#fff" stroke-width="2" fill="transparent" />
            </svg>
          </div>
        </section>
      </div>
    </main>
    <aside class="shadow-lg">
      <div id="aside-0" class="p-5 text-center">
        <h2>사용자 등록</h2>
        <form>
          <div class="mt-5">
            <input type="text" name="name">
          </div>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary position-static">시작하기</button>
          </div>
        </form>
      </div>
      <div id="aside-1" class="p-5 d-none transparent">
        <div class="pl-1 pr-3">
          <h2>환영합니다.<br><span data-bind="name"></span>님!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p>토론의 영역에 오신 것을 환영합니다!<br>탐험가님은 앞으로 미지의 의견들을 찾아 탐험해 나갈 것입니다.<br>Stances에서는 탐험가님의 길잡이가 될 수 있는 토론 지도를 제공해드립니다. 화면의 왼쪽이 앞으로 탐험가님이 어떤 의견 영역으로 나갈 것인지 도움이 될 수 있는 토론 지도 입니다.</p>
          <p>자, 이제 탐험을 위한 준비를 해볼까요?<br>준비는 총 3단계를 거칩니다. 이 과정을 통해서 의견들이 어떻게 만들어지고 연결될 수 있는지 살펴봅시다!</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary">시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-2" class="p-5 d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.1<br>나는 어디에 서 있을까?</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">시작하기에 앞서 나는 어떤 의견을 지지하고 있는지 확인을 해봅시다. 평소 우리는 의식하지 않지만, 생각보다 확고한 의견을 가지고 있을 때가 많습니다.</p>
          <p data-reveal="2">이번 단계에서는 선택한 주제와 관련된 주장에 대해 동의 혹은 반대할 것인지 선택합니다.</p>
          <p data-reveal="3">상단의 메뉴에서 원하는 주제를 골라주세요!</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-3" class="p-5 d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pt-4 pl-2 text-center">
            <input type="hidden" name="stance">
            <button id="stance-agree" type="button" class="btn btn-outline-secondary">동의</button><button id="stance-disagree" type="button" class="btn btn-outline-secondary">반대</button>
          </div>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-4" class="p-5 d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.2<br>나는 왜 여기에 서 있을까?</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">당신은 왜 그러한 선택을 했나요?</p>
          <p data-reveal="2">의견을 지지하는 것은 간단하지만, 구체적으로 왜 지지하는지에 대한 근거를 제시하는 것은 꽤 복잡한 과정입니다.</p>
          <p data-reveal="2">이번 단계에서는 새롭게 발견한 주장에 대해 구체적인 나의 생각을 덧붙일 것입니다. 밋밋한 지도에 나만의 색을 입히는 것이죠!</p>
          <p data-reveal="3">좌측 상단의 프로필을 클릭하여 나만의 색, 패턴을 설정해주세요. 그리고 앞의 주장에 대해 왜 그런 선택을 했는지 한 문장으로 답해봅시다.</p>
          <p data-reveal="3">당신의 토론 지도에 어떤 변화가 일어날까요?</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-5" class="p-5 d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3 style="opacity: 0.4;"><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pl-1 pr-5">
            <h3>반대하는 근거로</h3>
            <h3><textarea name="reason" placeholder="다로 끝나는 문장" rows="2" required></textarea>가<br>있다.</h3>
          </div>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-6" class="p-5 d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.3<br>서로 다르지만 함께 서 있을 수 있어!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">근거는 또 하나의 주장이 되어 다시 토론의 시작점으로 출발할 수 있습니다. 그런데, 주어진 질문에 대해 다른 사람들은 어떤 문장을 작성하였는지 궁금하지 않으신가요?</p>
          <p data-reveal="2">동의/반대를 떠나서 어떤 근거들이 당신과 함께할 수 있는 건지 한 번 알아볼까요?</p>
          <p data-reveal="3">랜덤하게 주어지는 근거들 중 동의하는 문장들을 선택해주세요.</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary reveal-static" data-reveal="4">시작하기</button>
          </div>
        </form>
      </div>
      <div id="aside-7" class="p-5 d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3 style="opacity: 0.4;"><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pl-1 pr-5">
            <div class="mt-1">
              <input id="topic-reason-0" type="checkbox" name="topic-reason-0" class="topic-reason"><label for="topic-reason-0"><span data-bind="topic-reason-0"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-1" type="checkbox" name="topic-reason-1" class="topic-reason"><label for="topic-reason-1"><span data-bind="topic-reason-1"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-2" type="checkbox" name="topic-reason-2" class="topic-reason"><label for="topic-reason-2"><span data-bind="topic-reason-2"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-3" type="checkbox" name="topic-reason-3" class="topic-reason"><label for="topic-reason-3"><span data-bind="topic-reason-3"></span></label>
            </div>
          </div>
          <div class="mt-5 text-right">
            <button type="submit" class="btn btn-primary">제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-8" class="p-5 d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">수고하셨습니다!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">이제 더 넓은 토론의 영역을 탐험해봅시다.</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary" data-reveal="2">좋아요!</button>
          </div>
        </form>
      </div>
    </aside>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha256-E/V4cWE4qvAeO5MOhjtGtqDzPndRO1LBk8lJ/PR7CA4=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>
    <script>
      firebase.initializeApp({
        projectId: "stances-do7922",
        authDomain: "stances-do7922.firebaseapp.com",
        databaseURL: "https://stances-do7922.firebaseio.com",
        apiKey: "AIzaSyCWO7N60K1Ph6cHKyblHOQ-4gwqBKoyYLs"
      });


      // Init and functions

      var tutorialData;

      $.getJSON('tutorial.json', function(data) {
        tutorialData = data;
        for (var key in data)
          $('#' + key).text(data[key].name);
      });

      var state = {};

      function stateUpdate(key, value) {
        state[key] = value;
        return $('[data-bind="' + key + '"]').text(value);
      }

      function fadeOutIn(oldSelector, newSelector) {
        var $old = $(oldSelector),
            $new = $(newSelector);

        $old.addClass('transparent');
        setTimeout(function() {
          $old.addClass('d-none');
          $new.removeClass('d-none');
          setTimeout(function() {
            $new.removeClass('transparent')
                .find('[data-reveal]').addClass('reveal');
          }, 50);
        }, 425);
      }


      // Colors

      var palette = {
        'grad-0': { agree: '#4bc0c8', disagree: '#feac5e' },
        'grad-1': { agree: '#30e8bf', disagree: '#ff8235' },
        'grad-2': { agree: '#0aa6bc', disagree: '#ff4b1f' },
        'grad-3': { agree: '#0abfbc', disagree: '#fc354c' }
      }

      for (var key in palette) {
        $('#' + key).find('stop:first-of-type').css('stop-color', palette[key].agree);
        $('#' + key).find('stop:last-of-type').css('stop-color', palette[key].disagree);
      }

      var paletteTemp = null,
          $ellipseMyself = $('#ellipse-myself');

      $('#grad-shuffle').click(function() {
        if (paletteTemp || $(this).prop('disabled'))
          $ellipseMyself.removeClass(paletteTemp);

        while (true) {
          var candidate = 'grad-' +  Math.floor(Math.random() * 4);
          if (paletteTemp !== candidate) {
            paletteTemp = candidate;
            break;
          }
        }
        $ellipseMyself.addClass('fill ' + paletteTemp);
        $('#grad-select').prop('disabled', false);
      });

      $('#grad-select').click(function() {
        if (!paletteTemp || $(this).prop('disabled'))
          return;

        state.palette = palette[paletteTemp];
        $ellipseMyself.removeClass(paletteTemp);
        $('#grad-shuffle').prop('disabled', true);
        $('#aside-4 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });


      // Landing scroll

      var firstSection = $('main section:first-child')[0],
          $aside = $('aside');

      $(window).scroll(function() {
        var rect = firstSection.getBoundingClientRect();
        if (rect.top < -80)
          $aside.not('.fixed').addClass('expanded');
        else
          $aside.not('.fixed').removeClass('expanded');
      });


      // Tutorial

      $('#topic-dropdown').on('hide.bs.dropdown', function(e) {
        if (e.clickEvent === undefined || e.clickEvent.target === undefined)
          return;

        var topic = tutorialData[e.clickEvent.target.id];
        stateUpdate('topic-name', topic.name);
        stateUpdate('topic-statement', topic.statement);
        stateUpdate('topic-reason-0', topic.reasons[0].content).data('stance', topic.reasons[0].stance);
        stateUpdate('topic-reason-1', topic.reasons[1].content).data('stance', topic.reasons[1].stance);
        stateUpdate('topic-reason-2', topic.reasons[2].content).data('stance', topic.reasons[2].stance);
        stateUpdate('topic-reason-3', topic.reasons[3].content).data('stance', topic.reasons[3].stance);

        $(this).find('.dropdown-toggle').text(topic.name);

        $('#aside-2 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });

      $('#aside-0 form').submit(function(e) {
        e.preventDefault();

        stateUpdate('name', $(this).find('[name="name"]').val());

        $aside.addClass('fixed').addClass('expanded');
        fadeOutIn('#aside-0', '#aside-1');
      });

      $('#aside-1 form').submit(function(e) {
        e.preventDefault();

        $('#main-1').removeClass('d-none');
        $('#main-0').addClass('d-none');
        fadeOutIn('#aside-1', '#aside-2');
      });

      $('#aside-2 form').submit(function(e) {
        e.preventDefault();

        $('#topic-dropdown .dropdown-toggle').dropdown('dispose').removeAttr('data-toggle');
        fadeOutIn('#aside-2', '#aside-3');
      });

      var $agree = $('#stance-agree'),
          $disagree = $('#stance-disagree'),
          $form3 = $('#aside-3 form'),
          $input3 = $form3.find('input[name="stance"]'),
          $submitButton3 = $form3.find('button[type="submit"]');

      $agree.click(function() {
        $agree.addClass('btn-outline-success').removeClass('btn-outline-secondary');
        $disagree.addClass('btn-outline-secondary').removeClass('btn-outline-danger');
        $ellipseMyself.removeClass('d-none');
        $input3.val('agree');
        $submitButton3.prop('disabled', false).removeClass('d-none');
      });

      $disagree.click(function() {
        $disagree.addClass('btn-outline-danger').removeClass('btn-outline-secondary');
        $agree.addClass('btn-outline-secondary').removeClass('btn-outline-success');
        $ellipseMyself.removeClass('d-none');
        $input3.val('disagree');
        $submitButton3.prop('disabled', false).removeClass('d-none');
      });

      $form3.submit(function(e) {
        e.preventDefault();

        $('.bg-primary').addClass('bg-darker').removeClass('bg-primary');
        $('#grad-actions').removeClass('d-none');
        stateUpdate('stance', $input3.val());

        fadeOutIn('#aside-3', '#aside-4');
      });

      $('#aside-4 form').submit(function(e) {
        e.preventDefault();

        $('.bg-darker').addClass('bg-primary').removeClass('bg-darker');
        $('#grad-actions').addClass('d-none');

        fadeOutIn('#aside-4', '#aside-5');
      });

      $('#aside-5 textarea').on('input', function(e) {
        $('#aside-5 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });

      $('#aside-5 form').submit(function(e) {
        e.preventDefault();

        $ellipseMyself.find('ellipse').css('fill', state.palette[state.stance]).removeAttr('fill');

        // Firbase writing
        fadeOutIn('#aside-5', '#aside-6');
      });

      $('#aside-6 form').submit(function(e) {
        e.preventDefault();

        fadeOutIn('#aside-6', '#aside-7');
      });

      $('#aside-7 form').submit(function(e) {
        e.preventDefault();

        fadeOutIn('#aside-7', '#aside-8');
      });
    </script>
  </body>
</html>
