<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,700">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
  </head>
  <body class="index">
    <main>
      <div id="main-0" class="bg-secondary">
        <section class="p-aside" style="background-image: url(splash.jpg);">
          <h1>Hello, world!</h1>
        </section>
        <section class="p-aside">
          <h1>Hello, world!</h1>
        </section>
        <section class="p-aside">
          <h1>Hello, world!</h1>
        </section>
      </div>
      <div id="main-1" class="bg-primary text-center d-none">
        <section class="p-aside">
          <div id="topic-dropdown" class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">주제 선택하기</button>
            <div class="dropdown-menu">
              <button id="topic-0" class="dropdown-item" type="button"></button>
              <button id="topic-1" class="dropdown-item" type="button"></button>
              <button id="topic-2" class="dropdown-item" type="button"></button>
              <button id="topic-3" class="dropdown-item" type="button"></button>
              <button id="topic-4" class="dropdown-item" type="button"></button>
            </div>
          </div>
        </section>
      </div>
    </main>
    <aside class="shadow-lg">
      <div id="aside-0" class="p-5 text-center">
        <h2>사용자 등록</h2>
        <form>
          <div class="mt-5">
            <input type="text" name="name">
          </div>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary">시작하기</button>
          </div>
        </form>
      </div>
      <div id="aside-1" class="p-5 d-none transparent">
        <h2>환영합니다! <span data-bind="name"></span>님</h2>
        <div class="mt-5">
          <p>지금부터 토론 지도에서 어떻게 탐험할 수 있는지 확인해봅시다!</p>
          <p>튜토리얼은 총 3단계를 거칩니다. 이 과정을 통해서 주장들이 어떻게 만들어지고 연결될 수 있는지 살펴보아요.</p>
        </div>
        <form>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary">좋아요!</a>
          </div>
        </form>
      </div>
      <div id="aside-2" class="p-5 d-none transparent">
        <h2>Step.1<br>나는 어디에 서 있을까?</h2>
        <div class="mt-5">
          <p>시작하기에 앞서 나는 어떤 의견을 지지하고 있는지 확인을 해봅시다. 평소 우리는 의식하지 않지만, 생각보다 확고한 의견을 가지고 있을 때가 많습니다.</p>
          <p>이번 단계에서는 선택한 주제와 관련된 주장에 대해 동의 혹은 반대할 것인지 선택합니다.</p>
          <p>상단의 메뉴에서 원하는 주제를 골라주세요!</p>
        </div>
        <form>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-3" class="p-5 d-none transparent">
        <h4>주제 - <span data-bind="topic-name"></span></h4>
        <h2><span data-bind="topic-statement"></span></h2>
        <form>
          <div class="mt-5">
            <input type="hidden" name="stance">
            <button id="stance-agree" type="button" class="btn btn-outline-secondary">동의</button>
            <button id="stance-disagree" type="button" class="btn btn-outline-secondary">반대</button>
          </div>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary" disabled>제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-4" class="p-5 d-none transparent">
        <h2>Step.2<br>나는 왜 여기에 서 있을까?</h2>
        <div class="mt-5">
          <p>당신은 왜 그러한 선택을 했나요?</p>
          <p>의견을 지지하는 것은 간단하지만, 구체적으로 왜 지지하는지에 대한 근거를 제시하는 것은 꽤 복잡한 과정입니다.</p>
          <p>이번 단계에서는 새롭게 발견한 주장에 대해 구체적인 나의 생각을 덧붙일 것입니다. 밋밋한 지도에 나만의 색을 입히는 것이죠!</p>
          <p>좌측 상단의 프로필을 클릭하여 나만의 색, 패턴을 설정해주세요. 그리고 앞의 주장에 대해 왜 그런 선택을 했는지 한 문장으로 답해봅시다.</p>
          <p>당신의 토론 지도에 어떤 변화가 일어날까요?</p>
        </div>
        <form>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-5" class="p-5 d-none transparent">
        <h4>주제 - <span data-bind="topic-name"></span></h4>
        <h2><span data-bind="topic-statement"></span></h2>
        <form>
          <div class="mt-5">
            <h2>반대하는 근거로</h2>
            <h2><textarea name="reason" placeholder="다로 끝나는 문장" rows="2" required></textarea>가 있다.</h2>
          </div>
          <div class="mt-5">
            <button type="submit" class="btn btn-primary">제출하기</button>
          </div>
        </form>
      </div>
    </aside>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha256-E/V4cWE4qvAeO5MOhjtGtqDzPndRO1LBk8lJ/PR7CA4=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>
    <script>
      firebase.initializeApp({
        projectId: "stances-do7922",
        authDomain: "stances-do7922.firebaseapp.com",
        databaseURL: "https://stances-do7922.firebaseio.com",
        apiKey: "AIzaSyCWO7N60K1Ph6cHKyblHOQ-4gwqBKoyYLs"
      });

      var tutorialData;

      $.getJSON('tutorial.json', function(data) {
        tutorialData = data;
        for (var key in data)
          $('#' + key).text(data[key].name);
      });

      var state = {};

      function stateUpdate(key, value) {
        state[key] = value;
        $el = $('[data-bind="' + key + '"]').text(value);
      }

      function fadeOutIn(oldSelector, newSelector) {
        var $old = $(oldSelector),
            $new = $(newSelector);

        $old.addClass('transparent');
        setTimeout(function() {
          $old.addClass('d-none');
          $new.removeClass('d-none');
          setTimeout(function() {
            $new.removeClass('transparent');
          }, 50);
        }, 425);
      }

      var firstSection = $('main section:first-child')[0],
          $aside = $('aside');

      $(window).scroll(function() {
        var rect = firstSection.getBoundingClientRect();
        if (rect.top < -80)
          $aside.not('.fixed').addClass('expanded');
        else
          $aside.not('.fixed').removeClass('expanded');
      });

      $('#topic-dropdown').on('hide.bs.dropdown', function(e) {
        if (e.clickEvent === undefined)
          return;

        var topic = tutorialData[e.clickEvent.target.id];
        stateUpdate('topic-name', topic.name);
        stateUpdate('topic-statement', topic.statement);

        $(this).find('.dropdown-toggle').text(topic.name);

        $('#aside-2 form button[type="submit"]').prop('disabled', false);
      });

      $('#aside-0 form').submit(function(e) {
        e.preventDefault();

        stateUpdate('name', $(this).find('[name="name"]').val());

        $aside.addClass('fixed').addClass('expanded');
        fadeOutIn('#aside-0', '#aside-1');
      });

      $('#aside-1 form').submit(function(e) {
        e.preventDefault();

        $('#main-1').removeClass('d-none');
        $('#main-0').addClass('d-none');
        fadeOutIn('#aside-1', '#aside-2');
      });

      $('#aside-2 form').submit(function(e) {
        e.preventDefault();

        $('#topic-dropdown .dropdown-toggle').dropdown('dispose'); // TODO: does not work.
        fadeOutIn('#aside-2', '#aside-3');
      });

      var $agree = $('#stance-agree'),
          $disagree = $('#stance-disagree'),
          $form = $('#aside-3 form'),
          $input = $form.find('input[name="stance"]'),
          $submitButton = $form.find('button[type="submit"]');

      $agree.click(function() {
        $agree.addClass('btn-outline-success').removeClass('btn-outline-secondary');
        $disagree.addClass('btn-outline-secondary').removeClass('btn-outline-danger');
        $input.val('agree');
        $submitButton.prop('disabled', false);
      });

      $disagree.click(function() {
        $disagree.addClass('btn-outline-danger').removeClass('btn-outline-secondary');
        $agree.addClass('btn-outline-secondary').removeClass('btn-outline-success');
        $input.val('disagree');
        $submitButton.prop('disabled', false);
      });

      $form.submit(function(e) {
        e.preventDefault();

        stateUpdate($input.val());

        fadeOutIn('#aside-3', '#aside-4');

        $('#aside-4 form button[type="submit"]').prop('disabled', false); // TODO: move to config
      });

      $('#aside-4 form').submit(function(e) {
        e.preventDefault();

        fadeOutIn('#aside-4', '#aside-5');
      });
    </script>
  </body>
</html>
