<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:100,500,700,900">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
  </head>
  <body class="index">
    <main>
      <div id="main-0" class="bg-primary">
        <section class="p-aside will-fade">
          <div class="position-relative bg-splash" style="background-image: url(splash.png); overflow: hidden;">
            <img id="hand-0" class="hand" src="hand0.png" width="298">
            <img id="hand-1" class="hand" src="hand1.png" width="256">
            <img id="hand-2" class="hand" src="hand2.png" width="284">
            <img id="hand-3" class="hand" src="hand3.png" width="296">
          </div>
        </section>
      </div>
      <div id="main-1" class="bg-primary bg-transition">
        <section class="p-aside will-fade d-none transparent">
          <div class="position-relative h-100 p-4 text-center">
            <div id="profile" class="position-relative float-left ml-2">
              <svg id="circle-profile" class="position-relative" xmlns="http://www.w3.org/2000/svg" width="40" height="40" style="z-index: 51;">
                <circle cx="20" cy="20" r="20" fill="#fff" />
              </svg><span class="d-inline-block position-relative ml-3" style="z-index: 51; font-size: 14px; vertical-align: -2px;" data-bind="user-name"></span>
              <svg id="circle-ripple" class="position-absolute" xmlns="http://www.w3.org/2000/svg" width="20" height="20" style="z-index: 50; top: 10px; left: 10px;">
                <circle cx="10" cy="10" r="10" fill="#001e50" />
              </svg>
              <div class="click-indicator d-none"></div>
            </div>
            <div id="topic-dropdown" class="dropdown mt-1 mr-3">
              <button class="btn btn-outline-light dropdown-toggle" type="button" data-toggle="dropdown">주제 선택하기</button>
              <div class="dropdown-menu">
                <button id="topic-0" class="dropdown-item" type="button"></button>
                <button id="topic-1" class="dropdown-item" type="button"></button>
                <button id="topic-2" class="dropdown-item" type="button"></button>
                <button id="topic-3" class="dropdown-item" type="button"></button>
              </div>
              <div class="click-indicator d-none"></div>
            </div>
            <div id="grad-actions" class="d-none">
              <button id="grad-shuffle" type="button" class="btn btn-outline-light"><img src="shuffle.svg" alt="Shuffle" width="21" height="14"></button>
            </div>
            <svg id="ellipse-myself" class="svg-ellipse d-none" xmlns="http://www.w3.org/2000/svg" width="360" height="120">
              <defs>
                <linearGradient id="grad-0">
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-1">
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-2">
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="grad-3">
                  <stop offset="0%" />
                  <stop offset="100%" />
                </linearGradient>
              </defs>
              <ellipse cx="180" cy="60" rx="179" ry="59" stroke="#fff" stroke-width="2" fill="transparent" />
            </svg>
            <svg id="ellipse-0" class="svg-ellipse will-fade d-none transparent" xmlns="http://www.w3.org/2000/svg" width="182" height="54">
              <ellipse cx="91" cy="27" rx="91" ry="27" stroke="transparent" fill="#003ca0" />
              <ellipse cx="91" cy="27" rx="91" ry="27" stroke="transparent" />
            </svg>
            <svg id="ellipse-1" class="svg-ellipse will-fade d-none transparent" xmlns="http://www.w3.org/2000/svg" width="130" height="36">
              <ellipse cx="65" cy="18" rx="65" ry="18" stroke="transparent" fill="#003ca0" />
              <ellipse cx="65" cy="18" rx="65" ry="18" stroke="transparent" />
            </svg>
            <svg id="ellipse-2" class="svg-ellipse will-fade d-none transparent" xmlns="http://www.w3.org/2000/svg" width="92" height="24">
              <ellipse cx="46" cy="12" rx="46" ry="12" stroke="transparent" fill="#003ca0" />
              <ellipse cx="46" cy="12" rx="46" ry="12" stroke="transparent" />
            </svg>
            <svg id="ellipse-3" class="svg-ellipse will-fade d-none transparent" xmlns="http://www.w3.org/2000/svg" width="62" height="14">
              <ellipse cx="31" cy="7" rx="31" ry="7" stroke="transparent" fill="#003ca0" />
              <ellipse cx="31" cy="7" rx="31" ry="7" stroke="transparent" />
            </svg>
            <svg id="lines" class="svg-lines position-absolute d-none" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" style="top: 0; left: 0; transform: scaleY(-1);">
              <defs>
                <linearGradient id="lines__grad-0">
                  <stop offset="0%" />
                  <stop offset="1%" />
                  <stop offset="2%" stop-color="transparent" />
                </linearGradient>
                <linearGradient id="lines__grad-1" class="grad-reverse">
                  <stop offset="98%" stop-color="transparent" />
                  <stop offset="99%" />
                  <stop offset="100%" />
                </linearGradient>
                <linearGradient id="lines__grad-2">
                  <stop offset="0%" />
                  <stop offset="1%" />
                  <stop offset="2%" stop-color="transparent" />
                </linearGradient>
                <linearGradient id="lines__grad-3" class="grad-reverse">
                  <stop offset="98%" stop-color="transparent" />
                  <stop offset="99%" />
                  <stop offset="100%" />
                </linearGradient>
              </defs>
              <line id="lines__line-0" class="d-none" x1="320" y1="97" x2="65" y2="368" stroke="url(#lines__grad-0)" stroke-width="3" style="opacity: 0.5;" />
              <line id="lines__line-1" class="d-none" x1="320" y1="97" x2="545" y2="433" stroke="url(#lines__grad-1)" stroke-width="3" style="opacity: 0.5;" />
              <line id="lines__line-2" class="d-none" x1="320" y1="97" x2="224" y2="499" stroke="url(#lines__grad-2)" stroke-width="3" style="opacity: 0.5;" />
              <line id="lines__line-3" class="d-none" x1="320" y1="97" x2="385" y2="564" stroke="url(#lines__grad-3)" stroke-width="3" style="opacity: 0.5;" />
            </svg>
          </div>
        </section>
      </div>
    </main>
    <aside class="shadow-lg expanded fixed">
      <div id="aside-0" class="will-fade text-center">
        <img src="logo.png" alt="Stances" width="100">
        <div class="mt-5">
          <h1>토론의<br>세계를<br>탐험하세요</h1>
        </div>
        <form style="margin-top: 176px;">
          <div>
            <input type="text" name="user-name" placeholder="이름을 입력하세요." style="width: 260px; height: 34px; font-size: 14px; text-align: center; border: 2px solid #7f7f7f; border-radius: 17px;" required>
          </div>
          <div style="margin-top: 32px;">
            <button type="submit" class="btn btn-primary position-static" style="width: 120px; height: 34px; font-size: 14px;">등록</button>
          </div>
        </form>
      </div>
      <div id="aside-1" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3">
          <h2>환영합니다.<br><span data-bind="user-name"></span>님!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p>토론의 영역에 오신 것을 환영합니다!<br>탐험가님은 앞으로 미지의 의견들을 찾아 탐험해 나갈 것입니다.<br>Stances에서는 탐험가님의 길잡이가 될 수 있는 토론 지도를 제공해드립니다. 화면의 왼쪽이 앞으로 탐험가님이 어떤 의견 영역으로 나갈 것인지 도움이 될 수 있는 토론 지도 입니다.</p>
          <p>자, 이제 탐험을 위한 준비를 해볼까요?<br>준비는 총 3단계를 거칩니다. 이 과정을 통해서 의견들이 어떻게 만들어지고 연결될 수 있는지 살펴봅시다!</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary">시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-2" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.1<br>나는 어디에 서 있을까?</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">시작하기에 앞서 나는 어떤 의견을 지지하고 있는지 확인을 해봅시다. 평소 우리는 의식하지 않지만, 생각보다 확고한 의견을 가지고 있을 때가 많습니다.</p>
          <p data-reveal="2">이번 단계에서는 선택한 주제와 관련된 주장에 대해 동의 혹은 반대할 것인지 선택합니다.</p>
          <p data-reveal="3">상단의 메뉴에서 원하는 주제를 골라주세요!</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-3" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pt-4 pl-2 text-center">
            <input type="hidden" name="stance" required>
            <button id="stance-agree" type="button" class="btn btn-outline-secondary">동의</button><button id="stance-disagree" type="button" class="btn btn-outline-secondary">반대</button>
          </div>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-4" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.2<br>나는 왜 여기에 서 있을까?</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">당신은 왜 그러한 선택을 했나요?</p>
          <p data-reveal="2">의견을 지지하는 것은 간단하지만, 구체적으로 왜 지지하는지에 대한 근거를 제시하는 것은 꽤 복잡한 과정입니다.</p>
          <p data-reveal="2">이번 단계에서는 새롭게 발견한 주장에 대해 구체적인 나의 생각을 덧붙일 것입니다. 밋밋한 지도에 나만의 색을 입히는 것이죠!</p>
          <p data-reveal="3">좌측 상단의 프로필을 클릭하여 나만의 색, 패턴을 설정해주세요. 그리고 앞의 주장에 대해 왜 그런 선택을 했는지 한 문장으로 답해봅시다.</p>
          <p data-reveal="3">당신의 토론 지도에 어떤 변화가 일어날까요?</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>시작하기</a>
          </div>
        </form>
      </div>
      <div id="aside-5" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3 style="opacity: 0.4;"><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pl-1">
            <h3><span data-bind-verbose="stance"></span>하는 근거로</h3>
            <h3><textarea name="reason" placeholder="‘~다’로 끝나는 한 문장으로 적어주세요." rows="2" required></textarea>가<br>있다.</h3>
          </div>
          <div>
            <button type="submit" class="btn btn-primary d-none" disabled>제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-6" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">Step.3<br>서로 다르지만 함께 서 있을 수 있어!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">근거는 또 하나의 주장이 되어 다시 토론의 시작점으로 출발할 수 있습니다. 그런데, 주어진 질문에 대해 다른 사람들은 어떤 문장을 작성하였는지 궁금하지 않으신가요?</p>
          <p data-reveal="2">동의/반대를 떠나서 어떤 근거들이 당신과 함께할 수 있는 건지 한 번 알아볼까요?</p>
          <p data-reveal="3">랜덤하게 주어지는 근거들 중 동의하는 문장들을 선택해주세요.</p>
        </div>
        <form>
          <div>
            <button type="submit" class="btn btn-primary reveal-static" data-reveal="4">시작하기</button>
          </div>
        </form>
      </div>
      <div id="aside-7" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3 pt-5">
          <h4>주제 - <span data-bind="topic-name"></span></h4>
          <h3 style="opacity: 0.4;"><span data-bind="topic-statement"></span></h3>
        </div>
        <form>
          <div class="mt-5 pl-1 pr-5">
            <div class="mt-1">
              <input id="topic-reason-0" type="checkbox" name="topic-reason-0" class="topic-reason" data-reason-id="0"><label for="topic-reason-0"><span data-bind="topic-reason-0"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-1" type="checkbox" name="topic-reason-1" class="topic-reason" data-reason-id="1"><label for="topic-reason-1"><span data-bind="topic-reason-1"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-2" type="checkbox" name="topic-reason-2" class="topic-reason" data-reason-id="2"><label for="topic-reason-2"><span data-bind="topic-reason-2"></span></label>
            </div>
            <div class="mt-1">
              <input id="topic-reason-3" type="checkbox" name="topic-reason-3" class="topic-reason" data-reason-id="3"><label for="topic-reason-3"><span data-bind="topic-reason-3"></span></label>
            </div>
          </div>
          <div class="mt-5 text-right">
            <button type="submit" class="btn btn-primary">제출하기</button>
          </div>
        </form>
      </div>
      <div id="aside-8" class="p-5 will-fade d-none transparent">
        <div class="pl-1 pr-3">
          <h2 data-reveal="0">수고하셨습니다!</h2>
        </div>
        <div class="mt-5 pl-1 pr-5">
          <p data-reveal="1">이제 더 넓은 토론의 영역을 탐험해봅시다.</p>
        </div>
        <form action="aftervisuals">
          <div>
            <input type="hidden" name="uid">
            <button type="submit" class="btn btn-primary reveal-static" data-reveal="2">좋아요!</button>
          </div>
        </form>
      </div>
    </aside>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha256-E/V4cWE4qvAeO5MOhjtGtqDzPndRO1LBk8lJ/PR7CA4=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-firestore.js"></script>
    <script>
      firebase.initializeApp({
        projectId: "stances-do7922",
        authDomain: "stances-do7922.firebaseapp.com",
        databaseURL: "https://stances-do7922.firebaseio.com",
        apiKey: "AIzaSyCWO7N60K1Ph6cHKyblHOQ-4gwqBKoyYLs"
      });

      var db = firebase.firestore();

      db.settings({
        timestampsInSnapshots: true
      });


      // Init and functions

      var tutorialData;

      $.getJSON('tutorial.json', function(data) {
        tutorialData = data;
        for (var key in data)
          $('#' + key).text(data[key].name);
      });

      var state = {};

      function stateUpdate(key, value) {
        state[key] = value;
        return $('[data-bind="' + key + '"]').text(value);
      }

      function fadeIn(selector) {
        var $el = $(selector);
        $el.removeClass('d-none');
        setTimeout(function() {
          $el.removeClass('transparent')
             .find('[data-reveal]').addClass('reveal');
        }, 50);
      }

      function fadeOutIn(oldSelector, newSelector) {
        var $old = $(oldSelector);
        $old.addClass('transparent');
        setTimeout(function() {
          $old.addClass('d-none');
          if (newSelector === undefined)
            return;
          var $new = $(newSelector);
          $new.removeClass('d-none');
          setTimeout(function() {
            $new.removeClass('transparent')
                .find('[data-reveal]').addClass('reveal');
          }, 50);
        }, 425);
      }


      // Colors

      var palette = {
        'grad-0': { agree: '#1565c0', disagree: '#de6161' },
        'grad-1': { agree: '#2657eb', disagree: '#b92b27' },
        'grad-2': { agree: '#00ba4b', disagree: '#f83600' },
        'grad-3': { agree: '#6be585', disagree: '#f37335' }
      }

      for (var key in palette) {
        $('#' + key).find('stop:first-of-type').attr('stop-color', palette[key].agree);
        $('#' + key).find('stop:last-of-type').attr('stop-color', palette[key].disagree);
      }

      var paletteTemp = null,
          $ellipseMyself = $('#ellipse-myself');

      $('#grad-shuffle').click(function() {
        if (paletteTemp || this.disabled)
          $ellipseMyself.removeClass(paletteTemp);

        while (true) {
          var candidate = 'grad-' +  Math.floor(Math.random() * 4);
          if (paletteTemp !== candidate) {
            paletteTemp = candidate;
            break;
          }
        }
        $ellipseMyself.addClass(paletteTemp).find('ellipse').attr('stroke', 'transparent');
        // $('#grad-select').prop('disabled', false);
        $('#aside-4 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });

      $('#aside-4 form').submit(function(e) {
        e.preventDefault();

        if (!paletteTemp)
          return;

        state.selectedColorSet = palette[paletteTemp];
        $ellipseMyself.removeClass(paletteTemp);
        $('#circle-profile').addClass(paletteTemp);
        $('#grad-actions').addClass('d-none');
        $('.bg-darker').removeClass('bg-darker');

        fadeOutIn('#aside-4', '#aside-5');
      });


      // Landing scroll

      var firstSection = $('main section:first-child')[0],
          $aside = $('aside');

      $(window).scroll(function() {
        var rect = firstSection.getBoundingClientRect();
        if (rect.top < -80)
          $aside.not('.fixed').addClass('expanded');
        else
          $aside.not('.fixed').removeClass('expanded');
      });


      // Tutorial

      var $topicDropdown = $('#topic-dropdown');

      $topicDropdown.find('.click-indicator').click(function(e) {
        e.stopPropagation();

        $(this).addClass('d-none');
        $topicDropdown.find('.dropdown-toggle').click();
      });

      $topicDropdown.on('show.bs.dropdown', function(e) {
        $(this).find('.click-indicator').addClass('d-none');
      });

      $topicDropdown.on('hide.bs.dropdown', function(e) {
        if (e.clickEvent === undefined || e.clickEvent.target === undefined || tutorialData[e.clickEvent.target.id] === undefined)
          return;

        var topic = tutorialData[e.clickEvent.target.id];
        stateUpdate('topic-codename', e.clickEvent.target.id);
        stateUpdate('topic-name', topic.name);
        stateUpdate('topic-statement', topic.statement);
        stateUpdate('topic-reason-0', topic.reasons[0].content).data('stance', topic.reasons[0].stance);
        stateUpdate('topic-reason-1', topic.reasons[1].content).data('stance', topic.reasons[1].stance);
        stateUpdate('topic-reason-2', topic.reasons[2].content).data('stance', topic.reasons[2].stance);
        stateUpdate('topic-reason-3', topic.reasons[3].content).data('stance', topic.reasons[3].stance);

        $(this).find('.dropdown-toggle').text(topic.name);

        $ellipseMyself.removeClass('d-none');
        $('#aside-2 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });

      $('#profile').click(function() {
        $(this).find('.click-indicator').addClass('d-none');

        $('.bg-primary').addClass('bg-darker');
        $('#grad-actions').removeClass('d-none');
      });

      $('#aside-0 form').submit(function(e) {
        e.preventDefault();

        stateUpdate('user-name', $(this).find('[name="user-name"]').val());

        $aside.addClass('fixed').addClass('expanded');
        fadeOutIn('#aside-0', '#aside-1');
      });

      $('#aside-1 form').submit(function(e) {
        e.preventDefault();

        db.collection('users').add({
          'name': state['user-name'],
          'timestamp': new Date()
        }).then(function(docRef) {
          state['user-id'] = docRef.id;
          $('input[name="uid"]').val(state['user-id']);
        });

        fadeOutIn('#aside-1', '#aside-2');
        fadeOutIn('#main-0 section', '#main-1 section');

        setTimeout(function() {
          if (state['topic-name'] === undefined)
            $topicDropdown.find('.click-indicator').removeClass('d-none');
        }, 5100);
      });

      $('#aside-2 form').submit(function(e) {
        e.preventDefault();

        $topicDropdown.find('.dropdown-toggle').dropdown('dispose').removeAttr('data-toggle');
        fadeOutIn('#aside-2', '#aside-3');
      });

      var $agree = $('#stance-agree'),
          $disagree = $('#stance-disagree'),
          $form3 = $('#aside-3 form'),
          $input3 = $form3.find('input[name="stance"]'),
          $submitButton3 = $form3.find('button[type="submit"]');

      $agree.click(function() {
        $agree.addClass('btn-outline-success').removeClass('btn-outline-secondary');
        $disagree.addClass('btn-outline-secondary').removeClass('btn-outline-danger');
        $ellipseMyself.addClass('fill');
        $input3.val('agree');
        $submitButton3.prop('disabled', false).removeClass('d-none');
      });

      $disagree.click(function() {
        $disagree.addClass('btn-outline-danger').removeClass('btn-outline-secondary');
        $agree.addClass('btn-outline-secondary').removeClass('btn-outline-success');
        $ellipseMyself.addClass('fill');
        $input3.val('disagree');
        $submitButton3.prop('disabled', false).removeClass('d-none');
      });

      $form3.submit(function(e) {
        e.preventDefault();

        setTimeout(function() {
          $('#profile .click-indicator').removeClass('d-none');
        }, 5100);

        stateUpdate('stance', $input3.val());

        var verboseStance;
        switch (state.stance) {
          case 'agree':
            verboseStance = '찬성'; break;
          case 'disagree':
            verboseStance = '반대'; break;
          default:
            verboseStance = '주장';
        }
        $('[data-bind-verbose="stance"]').text(verboseStance);

        fadeOutIn('#aside-3', '#aside-4');
      });

      $('#aside-5 textarea').on('input', function(e) {
        $('#aside-5 button[type="submit"]').prop('disabled', false).removeClass('d-none');
      });

      $('#aside-5 form').submit(function(e) {
        e.preventDefault();

        var color = state.selectedColorSet[state.stance];
        $ellipseMyself.find('ellipse').css('fill', color).removeAttr('fill');
        $('#lines linearGradient stop:nth-of-type(2)').attr('stop-color', color);
        state.usedColors = [color];
        state.reason = $.trim($(this).find('textarea').val());

        fadeOutIn('#aside-5', '#aside-6');
      });

      $('#aside-6 form').submit(function(e) {
        e.preventDefault();

        $ellipseMyself.addClass('moved');

        fadeOutIn('#aside-6', '#aside-7');
      });

      $('.topic-reason').change(function(e) {
        var stance = $('[data-bind="' + $(this).attr('name') + '"]').data('stance'),
            ellipseSelector = '#ellipse-' + $(this).data('reasonId'),
            $ellipse = $(ellipseSelector),
            $linesGrad = $('#lines__grad-' + $(this).data('reasonId')),
            color;

        if (!$ellipse.data('color')) {
          for (key in palette)
            if (state.usedColors.indexOf(palette[key][stance]) === -1) {
              color = palette[key][stance];
              break;
            }

          color = color || 'white';
          $ellipse.data('color', color)
                  .find('ellipse').not('[fill]').attr('fill', color);
          $linesGrad.not('.grad-reverse').find('stop:nth-of-type(1)').attr('stop-color', color);
          $linesGrad.filter('.grad-reverse').find('stop:nth-of-type(3)').attr('stop-color', color);
          state.usedColors.push(color);
        }

        if (this.checked)
          fadeIn(ellipseSelector);
        else
          fadeOutIn(ellipseSelector);
      });

      $('#aside-7 form').submit(function(e) {
        e.preventDefault();

        state.selectedReasons = [];

        var i;
        for (i = 0; i < 4; ++i) {
          if ($(this).find('[name="topic-reason-' + i + '"]').prop('checked')) {
            var topic = tutorialData[state['topic-codename'];
            state.selectedReasons.push(topic.reasons[i]]);
            $('#lines__line-' + i).removeClass('d-none');
          }
        }

        $('#lines').removeClass('d-none');

        i = 0;
        var refreshId = setInterval(function() {
          ++i;
          $('#lines linearGradient:not(.grad-reverse) stop:nth-of-type(2)').attr('offset', 1 + i + '%');
          $('#lines linearGradient:not(.grad-reverse) stop:nth-of-type(3)').attr('offset', 2 + i + '%');
          $('#lines linearGradient.grad-reverse stop:nth-of-type(1)').attr('offset', 98 - i + '%');
          $('#lines linearGradient.grad-reverse stop:nth-of-type(2)').attr('offset', 99 - i + '%');
          if (i >= 98)
            clearInterval(refreshId);
        }, 6);

        fadeOutIn('#aside-7', '#aside-8');
      });

      $('#aside-8 form').submit(function(e) {
        e.preventDefault();

        var form = this;

        db.collection('users').doc(state['user-id']).set({
          palette: state['selectedColorSet'],
          topic: {
            name: state['topic-name'],
            statement: state['topic-statement']
          },
          stance: state['stance'],
          reason: state['reason']
        }, {
          merge: true
        }).then(function() {
          form.submit();
        });
      });
    </script>
  </body>
</html>
